<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Baghdad Routes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; overflow: hidden; }
        
        .container { display: flex; flex-direction: column; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; }
        .sidebar { background: white; padding: 12px; overflow-y: auto; flex-shrink: 0; max-height: 40vh; box-shadow: 0 -2px 8px rgba(0,0,0,0.1); z-index: 1000; position: relative; }
        .map-container { flex: 1; position: relative; overflow: hidden; }
        #map { width: 100%; height: 100%; display: block; }
        
        h1 { font-size: 18px; margin-bottom: 10px; color: #333; }
        
        .form-group { margin-bottom: 10px; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 3px; }
        input, select { width: 100%; padding: 8px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; }
        input:focus { outline: none; border-color: #4CAF50; }
        
        button { width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; 
                 font-weight: bold; border-radius: 4px; margin-top: 8px; font-size: 13px; }
        button:active { background: #45a049; }
        
        .small-btn { width: auto; padding: 6px 10px; font-size: 11px; display: inline-block; margin: 3px 3px 3px 0; }
        
        .stats { display: flex; gap: 10px; margin: 10px 0; }
        .stat { flex: 1; background: #f0f7ff; padding: 8px; border-radius: 4px; text-align: center; font-size: 12px; }
        .stat-value { font-size: 16px; font-weight: bold; color: #4CAF50; }
        
        .error { background: #ffebee; color: #c62828; padding: 8px; border-radius: 4px; display: none; font-size: 11px; margin: 8px 0; }
        .success { background: #e8f5e9; color: #1b5e20; padding: 8px; border-radius: 4px; display: none; font-size: 11px; margin: 8px 0; }
        
        .spinner { width: 14px; height: 14px; border: 2px solid #f3f3f3; border-top: 2px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-buttons { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab-btn { flex: 1; padding: 8px; font-size: 11px; background: #f0f0f0; border: none; cursor: pointer; border-radius: 4px; }
        .tab-btn.active { background: #4CAF50; color: white; }
        
        .tab { display: none; }
        .tab.active { display: block; }
        
        @media (max-width: 600px) {
            .sidebar { max-height: 45vh; }
            h1 { font-size: 16px; }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <h1>üó∫Ô∏è Baghdad Routes</h1>
        
        <div class="tab-buttons">
            <button class="tab-btn active" onclick="showTab('route')">Route</button>
            <button class="tab-btn" onclick="showTab('history')">History</button>
            <button class="tab-btn" onclick="showTab('gps')">GPS</button>
        </div>
        
        <!-- ROUTE TAB -->
        <div id="route" class="tab active">
            <div class="form-group">
                <label>üìç From</label>
                <input type="text" id="origin" placeholder="Address or lat,lon">
            </div>
            <div class="form-group">
                <label>üéØ To</label>
                <input type="text" id="destination" placeholder="Address or lat,lon">
            </div>
            <button onclick="findRoute()">üöó Find Route</button>
            <button class="small-btn" style="width: auto; background: #999; margin-top: 5px;" onclick="clearMap()">Clear</button>
            
            <div class="error" id="error"></div>
            <div class="success" id="success"></div>
            
            <div class="stats" id="stats" style="display: none; margin-top: 10px;">
                <div class="stat">
                    <div class="stat-value" id="distance">0</div>
                    <div>Distance (km)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="time">0</div>
                    <div>Time (min)</div>
                </div>
            </div>
            
            <div id="directions" style="font-size: 11px; margin-top: 10px;"></div>
        </div>
        
        <!-- HISTORY TAB -->
        <div id="history" class="tab">
            <div id="historyList" style="font-size: 12px;"></div>
        </div>
        
        <!-- GPS TAB -->
        <div id="gps" class="tab">
            <button onclick="getGPS()">üìç Get My Location</button>
            <div id="gpsInfo" style="margin-top: 10px; font-size: 12px;"></div>
            <div id="savedLocations" style="margin-top: 15px;"></div>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
</div>

<script>
const map = L.map('map').setView([33.3128, 44.3615], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '¬© OSM', maxZoom: 18}).addTo(map);

let currentRoute = null;
const OSRM = 'https://router.project-osrm.org/route/v1/driving/'\;
const NOMINATIM = 'https://nominatim.openstreetmap.org/search?format=json&q='\;

async function geocode(addr) {
    if (/^[-\d.,\s]+$/.test(addr)) {
        const [lat, lon] = addr.split(',').map(x => parseFloat(x.trim()));
        if (!isNaN(lat) && !isNaN(lon)) return [lon, lat];
    }
    try {
        const res = await fetch(NOMINATIM + encodeURIComponent(addr + ', Baghdad'));
        const data = await res.json();
        if (data.length) return [parseFloat(data[0].lon), parseFloat(data[0].lat)];
    } catch (e) {}
    return null;
}

async function findRoute() {
    const origin = document.getElementById('origin').value.trim();
    const dest = document.getElementById('destination').value.trim();
    
    if (!origin || !dest) {
        showError('Enter origin and destination');
        return;
    }
    
    try {
        const orig = await geocode(origin);
        const destination_coord = await geocode(dest);
        
        if (!orig || !destination_coord) {
            showError('Location not found');
            return;
        }
        
        const res = await fetch(`${OSRM}${orig.join(',')};${destination_coord.join(',')}`);
        const data = await res.json();
        
        if (data.code !== 'Ok') {
            showError('Route not found');
            return;
        }
        
        const route = data.routes[0];
        currentRoute = {
            coordinates: route.geometry.coordinates.map(c => [c[1], c[0]]),
            distance: route.distance / 1000,
            time: Math.round(route.duration / 60)
        };
        
        clearMap();
        
        L.circleMarker([orig[1], orig[0]], {radius: 8, fillColor: '#4CAF50', color: '#fff', weight: 2}).addTo(map);
        L.circleMarker([destination_coord[1], destination_coord[0]], {radius: 8, fillColor: '#f44336', color: '#fff', weight: 2}).addTo(map);
        L.polyline(currentRoute.coordinates, {color: '#2196F3', weight: 4}).addTo(map);
        
        const bounds = L.latLngBounds(currentRoute.coordinates);
        map.fitBounds(bounds, {padding: [50, 50]});
        
        document.getElementById('distance').textContent = currentRoute.distance.toFixed(1);
        document.getElementById('time').textContent = currentRoute.time;
        document.getElementById('stats').style.display = 'flex';
        
        showSuccess(`‚úÖ Found! ${currentRoute.distance.toFixed(1)} km (${currentRoute.time} min)`);
        
        saveHistory(origin, dest, currentRoute.distance);
        
    } catch (e) {
        showError('Error: ' + e.message);
    }
}

function clearMap() {
    map.eachLayer(layer => {
        if (layer instanceof L.CircleMarker || layer instanceof L.Polyline) map.removeLayer(layer);
    });
    document.getElementById('stats').style.display = 'none';
    document.getElementById('directions').innerHTML = '';
}

function getGPS() {
    if ('geolocation' in navigator) {
        navigator.geolocation.getCurrentPosition((pos) => {
            const {latitude, longitude, accuracy} = pos.coords;
            document.getElementById('origin').value = `${latitude.toFixed(6)},${longitude.toFixed(6)}`;
            document.getElementById('gpsInfo').innerHTML = `<strong>‚úÖ Got your location!</strong><br>Lat: ${latitude.toFixed(4)}<br>Lon: ${longitude.toFixed(4)}<br>Accuracy: ¬±${accuracy.toFixed(0)}m`;
            
            if (map) {
                L.circleMarker([latitude, longitude], {radius: 8, fillColor: '#2196F3', color: '#fff', weight: 2}).addTo(map);
                map.setView([latitude, longitude], 16);
            }
        }, () => {
            showError('GPS denied or unavailable');
        }, {enableHighAccuracy: true, timeout: 10000});
    }
}

function saveHistory(origin, dest, distance) {
    let hist = JSON.parse(localStorage.getItem('routeHistory') || '[]');
    hist.unshift({origin, dest, distance: distance.toFixed(1)});
    hist = hist.slice(0, 10);
    localStorage.setItem('routeHistory', JSON.stringify(hist));
}

function loadHistory() {
    const hist = JSON.parse(localStorage.getItem('routeHistory') || '[]');
    document.getElementById('historyList').innerHTML = hist.map(h => 
        `<div style="padding: 8px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="document.getElementById('origin').value='${h.origin}'; document.getElementById('destination').value='${h.dest}'; showTab('route');">
            <strong>${h.origin}</strong> ‚Üí <strong>${h.dest}</strong><br>
            <small>${h.distance} km</small>
        </div>`
    ).join('') || '<p>No history</p>';
}

function showTab(name) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    event.target.classList.add('active');
    if (name === 'history') loadHistory();
}

function showError(msg) {
    const e = document.getElementById('error');
    e.textContent = msg;
    e.style.display = 'block';
    setTimeout(() => e.style.display = 'none', 4000);
}

function showSuccess(msg) {
    const s = document.getElementById('success');
    s.textContent = msg;
    s.style.display = 'block';
    setTimeout(() => s.style.display = 'none', 3000);
}

document.getElementById('origin').onkeypress = document.getElementById('destination').onkeypress = (e) => {
    if (e.key === 'Enter') findRoute();
};
</script>
</body>
</html>
