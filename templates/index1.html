<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baghdad Router Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; }
        body.dark { background: #1e1e1e; color: #eee; }
        
        .container { display: flex; height: 100vh; }
        .sidebar { width: 380px; background: white; padding: 20px; overflow-y: auto; box-shadow: 2px 0 8px rgba(0,0,0,0.1); }
        body.dark .sidebar { background: #2d2d2d; }
        .map-container { flex: 1; }
        #map { width: 100%; height: 100%; }
        
        h1 { font-size: 22px; margin-bottom: 15px; color: #333; }
        body.dark h1 { color: #fff; }
        
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #ddd; }
        body.dark .tabs { border-color: #444; }
        
        .tab-btn {
            padding: 8px 12px; cursor: pointer; border: none; background: none;
            font-size: 13px; font-weight: 600; color: #666; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { color: #4CAF50; border-color: #4CAF50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .form-group { margin-bottom: 12px; }
        label { display: block; font-size: 12px; font-weight: 600; margin-bottom: 4px; color: #555; }
        body.dark label { color: #aaa; }
        input, select, textarea { width: 100%; padding: 8px; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
        body.dark input, body.dark select, body.dark textarea { background: #3d3d3d; color: #eee; border-color: #555; }
        
        input:focus, select:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 4px rgba(76, 175, 80, 0.3); }
        
        button { width: 100%; padding: 10px; background: #4CAF50; color: white; border: none; cursor: pointer; font-weight: 600; border-radius: 4px; transition: background 0.2s; margin-top: 8px; }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .small-btn { width: auto; padding: 6px 10px; font-size: 11px; display: inline-block; margin: 2px; }
        
        .info { background: #f0f7ff; padding: 10px; border-radius: 4px; margin: 10px 0; font-size: 12px; color: #333; }
        body.dark .info { background: #3d4d6d; }
        
        .error { background: #fdeaea; color: #c53030; padding: 8px; border-radius: 4px; display: none; font-size: 11px; }
        .success { background: #e6fffa; color: #0d7377; padding: 8px; border-radius: 4px; display: none; font-size: 11px; }
        
        .spinner { width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; margin-right: 5px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .history-item { padding: 8px; margin: 5px 0; background: #f9f9f9; border-radius: 4px; cursor: pointer; font-size: 11px; border-left: 3px solid #4CAF50; }
        body.dark .history-item { background: #3d3d3d; }
        .history-item:hover { opacity: 0.8; }
        
        .waypoint-item { display: flex; gap: 5px; margin: 5px 0; }
        .waypoint-item input { flex: 1; }
        .waypoint-item button { width: 30px; margin: 0; }
        
        .toggle { float: right; cursor: pointer; font-size: 18px; }
        
        hr { border: none; border-top: 1px solid #ddd; margin: 15px 0; }
        body.dark hr { border-color: #444; }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h1>üó∫Ô∏è Baghdad Router</h1>
            <div class="toggle" id="darkToggle">üåô</div>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" data-tab="route">Route</button>
            <button class="tab-btn" data-tab="history">History</button>
            <button class="tab-btn" data-tab="favorites">Favorites</button>
            <button class="tab-btn" data-tab="export">Export</button>
        </div>
        
        <!-- ROUTE TAB -->
        <div id="route" class="tab-content active">
            <form id="routeForm">
                <div class="form-group">
                    <label>üìç Origin</label>
                    <input type="text" id="origin" placeholder="32.5364,44.4200 or address" autocomplete="off">
                </div>
                <div class="form-group">
                    <label>üéØ Destination</label>
                    <input type="text" id="destination" placeholder="33.3128,44.3615 or address" autocomplete="off">
                </div>
                
                <label style="font-size: 11px;">+ Waypoints</label>
                <div id="waypointsContainer"></div>
                <button type="button" class="small-btn" id="addWaypoint">+ Add Waypoint</button>
                
                <button type="submit" id="findBtn">Find Route</button>
                <button type="button" id="clearBtn" class="small-btn" style="width: auto; background: #999;">Clear</button>
            </form>
            
            <div id="loading" style="display: none; text-align: center; margin: 15px 0;">
                <span class="spinner"></span> Computing...
            </div>
            <div class="error" id="error"></div>
            <div class="success" id="success"></div>
            
            <div class="info" id="routeInfo" style="display: none;">
                <strong>Distance:</strong> <span id="distance">-</span> km<br>
                <strong>Time:</strong> <span id="time">-</span> min<br>
            </div>
        </div>
        
        <!-- HISTORY TAB -->
        <div id="history" class="tab-content">
            <h3 style="font-size: 14px; margin-bottom: 10px;">Recent Routes</h3>
            <div id="historyList"></div>
        </div>
        
        <!-- FAVORITES TAB -->
        <div id="favorites" class="tab-content">
            <div class="form-group">
                <label>Name for favorite:</label>
                <input type="text" id="favName" placeholder="e.g., Home, Work">
                <input type="hidden" id="favLat">
                <input type="hidden" id="favLon">
                <button id="saveFavBtn">Save Favorite</button>
            </div>
            <hr>
            <h3 style="font-size: 14px; margin-bottom: 10px;">Your Favorites</h3>
            <div id="favList"></div>
        </div>
        
        <!-- EXPORT TAB -->
        <div id="export" class="tab-content">
            <label style="font-size: 12px;">Export current route:</label>
            <button id="exportGeoJSON" class="small-btn">GeoJSON</button>
            <button id="exportGPX" class="small-btn">GPX</button>
            <button id="exportCSV" class="small-btn">CSV</button>
            <hr>
            <label style="font-size: 12px;">Avoid Area (min_lat,max_lat,min_lon,max_lon):</label>
            <textarea id="avoidZone" style="height: 60px;"></textarea>
            <button id="addAvoid">Add Avoid Zone</button>
        </div>
    </div>
    
    <div class="map-container">
        <div id="map"></div>
    </div>
</div>

<script>
const map = L.map('map').setView([33.3128, 44.3615], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap',
    maxZoom: 19,
}).addTo(map);

let currentRoute = null;

// Dark mode toggle
document.getElementById('darkToggle').onclick = () => {
    document.body.classList.toggle('dark');
    localStorage.setItem('darkMode', document.body.classList.contains('dark'));
};
if (localStorage.getItem('darkMode') === 'true') document.body.classList.add('dark');

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.onclick = () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        if (btn.dataset.tab === 'history') loadHistory();
        if (btn.dataset.tab === 'favorites') loadFavorites();
    };
});

// Add waypoint
document.getElementById('addWaypoint').onclick = (e) => {
    e.preventDefault();
    const container = document.getElementById('waypointsContainer');
    const div = document.createElement('div');
    div.className = 'waypoint-item';
    div.innerHTML = '<input type="text" placeholder="Waypoint address" autocomplete="off"><button type="button">‚úï</button>';
    div.querySelector('button').onclick = (e) => { e.preventDefault(); div.remove(); };
    container.appendChild(div);
};

// Find route
document.getElementById('routeForm').onsubmit = async (e) => {
    e.preventDefault();
    const origin = document.getElementById('origin').value.trim();
    const dest = document.getElementById('destination').value.trim();
    
    if (!origin || !dest) {
        showError('Enter origin and destination');
        return;
    }
    
    const waypoints = Array.from(document.querySelectorAll('#waypointsContainer input'))
        .map(inp => inp.value.trim()).filter(v => v);
    
    document.getElementById('loading').style.display = 'block';
    
    try {
        const res = await fetch('/api/route', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({origin, destination: dest, waypoints, num_routes: 1})
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        clearMap();
        currentRoute = data.routes[0];
        
        L.circleMarker(data.origin, {radius: 8, fillColor: '#4CAF50', color: '#fff', weight: 2, fillOpacity: 0.8})
            .addTo(map).bindPopup('Origin');
        
        L.circleMarker(data.destination, {radius: 8, fillColor: '#f44336', color: '#fff', weight: 2, fillOpacity: 0.8})
            .addTo(map).bindPopup('Destination');
        
        L.polyline(currentRoute.coordinates, {color: '#2196F3', weight: 4, opacity: 0.8}).addTo(map);
        
        const group = new L.featureGroup([
            L.circleMarker(data.origin),
            L.circleMarker(data.destination)
        ]);
        map.fitBounds(group.getBounds(), {padding: [50, 50]});
        
        document.getElementById('distance').textContent = currentRoute.length_km.toFixed(2);
        document.getElementById('time').textContent = Math.round(currentRoute.time_minutes);
        document.getElementById('routeInfo').style.display = 'block';
        
        showSuccess(`Route: ${currentRoute.length_km.toFixed(2)} km (${Math.round(currentRoute.time_minutes)} min)`);
        
        document.getElementById('favLat').value = data.origin[0];
        document.getElementById('favLon').value = data.origin[1];
        
    } catch (err) {
        showError(err.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
};

function clearMap() {
    map.eachLayer(layer => {
        if (layer instanceof L.CircleMarker || layer instanceof L.Polyline) map.removeLayer(layer);
    });
}

function showError(msg) {
    const err = document.getElementById('error');
    err.textContent = msg;
    err.style.display = 'block';
}

function showSuccess(msg) {
    const succ = document.getElementById('success');
    succ.textContent = msg;
    succ.style.display = 'block';
    setTimeout(() => succ.style.display = 'none', 3000);
}

document.getElementById('clearBtn').onclick = (e) => {
    e.preventDefault();
    document.getElementById('origin').value = '';
    document.getElementById('destination').value = '';
    document.getElementById('waypointsContainer').innerHTML = '';
    clearMap();
};

// Load history
async function loadHistory() {
    try {
        const res = await fetch('/api/history');
        const data = await res.json();
        const list = document.getElementById('historyList');
        list.innerHTML = data.routes.length ? data.routes.map(r => `<div class="history-item" onclick="document.getElementById('origin').value='${r.origin}'; document.getElementById('destination').value='${r.destination}';">
            <strong>${r.origin}</strong> ‚Üí <strong>${r.destination}</strong><br>
            <small>${r.distance_km.toFixed(2)} km</small>
        </div>`).join('') : '<p style="font-size: 11px;">No history</p>';
    } catch (e) { console.error(e); }
}

// Manage favorites
async function loadFavorites() {
    try {
        const res = await fetch('/api/favorites');
        const data = await res.json();
        const list = document.getElementById('favList');
        list.innerHTML = data.favorites.length ? data.favorites.map(f =>
            `<div class="history-item" onclick="document.getElementById('origin').value='${f.lat},${f.lon}';">
                üìå ${f.name}
            </div>`
        ).join('') : '<p style="font-size: 11px;">No favorites</p>';
    } catch (e) { console.error(e); }
}

document.getElementById('saveFavBtn').onclick = async () => {
    const name = document.getElementById('favName').value.trim();
    const lat = parseFloat(document.getElementById('favLat').value);
    const lon = parseFloat(document.getElementById('favLon').value);
    
    if (!name || !lat || !lon) {
        showError('Complete a route first');
        return;
    }
    
    try {
        await fetch('/api/favorites', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, lat, lon})
        });
        document.getElementById('favName').value = '';
        showSuccess('Favorite saved!');
        loadFavorites();
    } catch (e) { showError('Error'); }
};

// Export
document.getElementById('exportGeoJSON').onclick = () => exportRoute('geojson');
document.getElementById('exportGPX').onclick = () => exportRoute('gpx');
document.getElementById('exportCSV').onclick = () => exportRoute('csv');

async function exportRoute(fmt) {
    if (!currentRoute) { showError('Compute a route first'); return; }
    try {
        const res = await fetch(`/api/export/${fmt}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({coordinates: currentRoute.coordinates})
        });
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `route.${fmt === 'geojson' ? 'geojson' : fmt === 'gpx' ? 'gpx' : 'csv'}`;
        a.click();
        showSuccess('Exported!');
    } catch (e) { showError('Export failed'); }
}

document.getElementById('addAvoid').onclick = async () => {
    const zone = document.getElementById('avoidZone').value.trim();
    if (!zone) return;
    try {
        const parts = zone.split(',').map(Number);
        if (parts.length !== 4) throw new Error('Need 4 numbers');
        await fetch('/api/avoid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({zone: parts})
        });
        showSuccess('Zone added');
        document.getElementById('avoidZone').value = '';
    } catch (e) { showError('Invalid format'); }
};

[document.getElementById('origin'), document.getElementById('destination')].forEach(inp => {
    inp.onkeypress = (e) => { if (e.key === 'Enter') document.getElementById('routeForm').dispatchEvent(new Event('submit')); };
});
</script>
</body>
</html>
